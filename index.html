<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SSI Sports Nutrition</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="SSI Nutrition" />
    <link rel="apple-touch-icon" href="images/app-icon.png" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { --hot-pink: #ff69b4; --black: #121212; --dark-grey: #1e1e1e; --white: #ffffff; --blue: #00d4ff; --gold: #ffd700; --danger: #ff4d4d; }
        body { background-color: var(--black); color: var(--white); font-family: 'Arial Black', sans-serif; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 450px; background-color: var(--dark-grey); padding: 20px; border-radius: 20px; border: 2px solid var(--hot-pink); box-shadow: 0 0 20px rgba(255,105,180,0.2); }
        h1 { color: var(--hot-pink); text-align: center; margin: 0 0 15px 0; font-size: 1rem; text-transform: uppercase; }
        nav { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-bottom: 20px; }
        nav button { background: #333; color: white; border: none; padding: 10px 2px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.55rem; }
        nav button.active { background: var(--hot-pink); color: var(--black); }
        .card { background: var(--black); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #333; }
        .card h3 { margin: 0 0 10px 0; font-size: 0.7rem; color: var(--hot-pink); text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #444; background: #1a1a1a; color: white; box-sizing: border-box; font-family: sans-serif; }
        .btn-main { width: 100%; background: var(--hot-pink); color: var(--black); border: none; padding: 15px; border-radius: 10px; font-weight: 900; cursor: pointer; text-transform: uppercase; }
        .btn-h2o { background: transparent; border: 1px solid var(--blue); color: var(--blue); padding: 8px; border-radius: 8px; font-size: 0.7rem; flex: 1; cursor: pointer; }
        .history-list { margin-top: 15px; max-height: 250px; overflow-y: auto; }
        nav { display:flex; gap:6px; justify-content:center; margin-bottom:10px; }
        button { cursor:pointer; padding:8px 10px; border-radius:8px; border:none; background:#333; color:#fff; }
        .card { background:#0f0f0f; padding:12px; border-radius:10px; margin-bottom:10px; border: 1px solid #222; }
        .btn-main { background: var(--hot-pink); border: none; color: #000; padding: 8px 12px; border-radius: 8px; font-weight: bold; }
        input, select, textarea { width: calc(100% - 10px); padding: 8px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #333; background: #121212; color: #fff; box-sizing: border-box; }
        .history-list { max-height: 200px; overflow:auto; margin-top:8px; }
        .history-item { background: #252525; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--hot-pink); }
        .item-h2o { border-left-color: var(--blue); }
        .del-btn { color: var(--danger); font-weight: bold; cursor: pointer; background: none; border: none; font-size: 1.2rem; }
@@ -50,18 +47,46 @@
        <div style="text-align:center; font-size: 2.5rem; margin-bottom: 5px;" id="display-rem">0</div>
        <div class="card" style="border-color: var(--blue); text-align: center;">
            <div style="font-size: 1.5rem; color: var(--blue); margin-bottom: 10px;" id="display-h2o">0 ml</div>
            <div style="display:flex; gap:10px;"><button class="btn-h2o" onclick="addWater(250)">+ Glass</button><button class="btn-h2o" onclick="addWater(500)">+ Bottle</button></div>

            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:8px;">
                <button class="btn-h2o" onclick="addWater(250)">+ Glass</button>
                <button class="btn-h2o" onclick="addWater(500)">+ Bottle</button>
            </div>

            <select id="quick-food" onchange="applyQuickFood()">
                <option value="">-- SSI Verified Food List --</option>
                <option value="450|Oats with Berries">Oats & Berries (450 kcal)</option>
                <option value="600|Chicken & Rice">Chicken & Rice (600 kcal)</option>
                <option value="750|Pasta Bolognese">Pasta Bolognese (750 kcal)</option>
                <option value="350|Recovery Shake">Recovery Shake (350 kcal)</option>
            </select>

            <!-- NEW: optional date + time inputs (if left blank we use now) -->
            <div style="display:flex; gap:8px;">
                <input type="date" id="food-date" title="Optional: choose a date" style="width:50%;">
                <input type="time" id="food-time" title="Optional: choose a time" style="width:50%;">
            </div>

            <input type="text" id="food-name" placeholder="Food Name">
            <input type="number" id="food-cal" placeholder="Calories">
            <div style="display:flex; gap:8px;">
                <button class="btn-main" onclick="logFood()">Log Fuel</button>
                <button onclick="exportDiaryCSV()">Export CSV</button>
                <button onclick="renderDiaryChart(7)">Refresh Chart</button>
            </div>
        </div>

        <!-- NEW: diary chart area -->
        <div class="card" style="padding:5px; margin-top:6px;">
            <canvas id="chartDiary" height="120"></canvas>
            <div style="display:flex; gap:8px; margin-top:6px; justify-content:center;">
                <button class="btn-main" onclick="renderDiaryChart(1)">1d</button>
                <button class="btn-main" onclick="renderDiaryChart(7)">7d</button>
                <button class="btn-main" onclick="renderDiaryChart(30)">1m</button>
                <button class="btn-main" onclick="renderDiaryChart(90)">3m</button>
            </div>
        </div>
        <select id="quick-food" onchange="applyQuickFood()">
            <option value="">-- SSI Verified Food List --</option>
            <option value="450|Oats with Berries">Oats & Berries (450 kcal)</option>
            <option value="600|Chicken & Rice">Chicken & Rice (600 kcal)</option>
            <option value="750|Pasta Bolognese">Pasta Bolognese (750 kcal)</option>
            <option value="350|Recovery Shake">Recovery Shake (350 kcal)</option>
        </select>
        <input type="text" id="food-name" placeholder="Food Name">
        <input type="number" id="food-cal" placeholder="Calories">
        <button class="btn-main" onclick="logFood()">Log Fuel</button>

        <div id="list-diary" class="history-list"></div>
    </div>

@@ -88,18 +113,47 @@
    </div>

    <div id="page-goals" style="display:none;">
        <div class="card"><h3>SSI Plan</h3><select id="goal-strategy"><option value="Maintain">Maintain</option><option value="Put on Weight">Bulk</option><option value="Lose Weight">Cut</option></select><input id="goal-cals" placeholder="Target Calories"><input id="goal-weight" placeholder="Goal weight kg"><textarea id="coach-note" placeholder="Coach Feedback..."></textarea><button class="btn-main" style="background:var(--gold);" onclick="generatePDF()">Download PDF</button></div>
        <div class="card"><h3>SSI Plan</h3>
            <select id="goal-strategy"><option value="Maintain">Maintain</option><option value="Put on Weight">Bulk</option><option value="Lose Weight">Cut</option></select>
            <input id="goal-cals" placeholder="Target Calories">
            <input id="goal-weight" placeholder="Goal weight kg">
            <textarea id="coach-note" placeholder="Coach Feedback..."></textarea>
            <div style="display:flex; gap:8px;">
                <button class="btn-main" style="background:var(--gold);" onclick="generatePDF()">Download PDF</button>
                <button onclick="clearAll()">Wipe Data</button>
            </div>
        </div>
    </div>
</div>

<script>
    // NOTE: API key removed from client-side. Proxy via Netlify Function.
    // localStorage keys
    // localStorage keys and initial load
    let diary = JSON.parse(localStorage.getItem('ssiDiary')) || [];
    let well = JSON.parse(localStorage.getItem('ssiWell')) || [];
    let bodyData = JSON.parse(localStorage.getItem('ssiBody')) || [];
    let config = JSON.parse(localStorage.getItem('ssiConfig')) || { cals: 2500, weight: 75, strategy: 'Maintain' };
    let chart;
    let diaryChart;
    let selectedDiaryRange = 7; // default 7 days

    // Migrate/backfill missing timestamps for older entries
    (function backfillDiary() {
        let changed = false;
        diary = diary.map(item => {
            if (!item.t) {
                const now = new Date().toISOString();
                item.t = now;
                item.d = now.split('T')[0];
                changed = true;
            } else if (!item.d) {
                item.d = item.t.split('T')[0];
                changed = true;
            }
            return item;
        });
        if (changed) localStorage.setItem('ssiDiary', JSON.stringify(diary));
    })();

    window.onload = () => {
        document.getElementById('body-date').value = new Date().toISOString().split('T')[0];
@@ -110,6 +164,7 @@
        updateUI();
        updateWellList();
        updateBodyList();
        renderDiaryChart(selectedDiaryRange);
    };

    function switchPage(p) {
@@ -122,51 +177,6 @@
        if (p === 'body') { renderChart(); updateBodyList(); }
    }

    // askGemini now calls Netlify Function at /.netlify/functions/gemini
    async function askGemini() {
        const input = document.getElementById('ai-input').value;
        const resp = document.getElementById('ai-response');
        if (!input) return;
        resp.innerText = "Consulting SSI AI...";

        try {
            const r = await fetch('/.netlify/functions/gemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: input, strategy: config.strategy })
            });

            let d;
            const contentType = r.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                d = await r.json();
            } else {
                const text = await r.text();
                throw new Error(`Server returned non-JSON response (${r.status}): ${text.substring(0, 100)}...`);
            }

            if (!r.ok) {
                const errMsg = d.error || d.message || `Error ${r.status}`;
                resp.innerText = `System Error: ${errMsg}`;
                console.error("API Error", d);
                return;
            }

            // This is the typical Gemini generateContent response shape, but inspect if different.
            if (d && d.candidates && d.candidates[0] && d.candidates[0].content && d.candidates[0].content.parts) {
                resp.innerText = d.candidates[0].content.parts[0].text || JSON.stringify(d);
            } else if (d && d.output && d.output[0] && d.output[0].content) {
                // alternate shape fallback
                resp.innerText = JSON.stringify(d.output[0].content);
            } else {
                resp.innerText = JSON.stringify(d);
            }
        } catch (e) {
            console.error(e);
            resp.innerText = `Error: ${e.message}`;
        }
    }

    // Diary / Food
    function applyQuickFood() {
        const val = document.getElementById('quick-food').value;
@@ -180,21 +190,53 @@
        const n = document.getElementById('food-name').value;
        const c = parseInt(document.getElementById('food-cal').value);
        if (!n || isNaN(c)) return alert('Enter food name and calories');
        diary.push({ id: Date.now(), n, c, type: 'food' });

        // Read optional date/time inputs
        const dateInput = document.getElementById('food-date').value; // YYYY-MM-DD or ''
        const timeInput = document.getElementById('food-time').value; // HH:MM or ''

        let timestamp;
        if (dateInput && timeInput) {
            timestamp = new Date(`${dateInput}T${timeInput}`);
        } else if (dateInput && !timeInput) {
            // If only date given, assume midday to avoid timezone issues
            timestamp = new Date(`${dateInput}T12:00`);
        } else if (!dateInput && timeInput) {
            // If only time given, use today's date with provided time
            const today = new Date().toISOString().split('T')[0];
            timestamp = new Date(`${today}T${timeInput}`);
        } else {
            timestamp = new Date();
        }
        const iso = timestamp.toISOString();
        const dateOnly = iso.split('T')[0]; // YYYY-MM-DD

        diary.push({ id: Date.now(), n, c, type: 'food', t: iso, d: dateOnly });
        saveDiary();

        // clear inputs
        document.getElementById('food-name').value = '';
        document.getElementById('food-cal').value = '';
        document.getElementById('food-date').value = '';
        document.getElementById('food-time').value = '';

        // refresh UI
        updateUI();
    }

    function addWater(ml) {
        diary.push({ id: Date.now(), n: 'Hydration', ml, type: 'h2o' });
        const now = new Date().toISOString();
        const day = now.split('T')[0];
        diary.push({ id: Date.now(), n: 'Hydration', ml, type: 'h2o', t: now, d: day });
        saveDiary();
        updateUI();
    }

    function deleteItem(id) {
        if (!confirm('Delete this item?')) return;
        diary = diary.filter(i => i.id !== id);
        saveDiary();
        updateUI();
    }

    function saveDiary() {
@@ -207,27 +249,14 @@
        const s = document.getElementById('well-sleep').value || '';
        const e = document.getElementById('well-energy').value || '';
        const n = document.getElementById('well-note').value || '';
        well.push({ id: Date.now(), date: new Date().toLocaleDateString(), s, e, n });
        const now = new Date().toISOString();
        well.push({ id: Date.now(), date: new Date().toLocaleDateString(), s, e, n, t: now });
        localStorage.setItem('ssiWell', JSON.stringify(well));
        document.getElementById('well-sleep').value = '';
        document.getElementById('well-note').value = '';
        updateWellList();
    }

    // Body
    function logBody() {
        const date = document.getElementById('body-date').value;
        const w = parseFloat(document.getElementById('body-weight').value);
        const bf = parseFloat(document.getElementById('body-fat').value);
        if (!date || isNaN(w)) return alert('Enter date and weight');
        bodyData.push({ id: Date.now(), date, w, bf });
        localStorage.setItem('ssiBody', JSON.stringify(bodyData));
        renderChart();
        updateBodyList();
        document.getElementById('body-weight').value = '';
        document.getElementById('body-fat').value = '';
    }

    function deleteBody(id) {
        if (!confirm('Delete this body entry?')) return;
        bodyData = bodyData.filter(b => b.id !== id);
@@ -246,9 +275,14 @@
        list.innerHTML = '';
        diary.slice().reverse().forEach(i => {
            const isH = i.type === 'h2o';
            const left = isH ? `ðŸ’§ ${i.ml}ml` : `${i.n} (${i.c} kcal)`;
            list.innerHTML += `<div class="history-item ${isH ? 'item-h2o' : ''}"><span>${left}</span><button class="del-btn" onclick="deleteItem(${i.id})">Ã—</button></div>`;
            const left = isH 
                ? `ðŸ’§ ${i.ml}ml ${i.t ? ' @ ' + new Date(i.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}` 
                : `${i.n} (${i.c} kcal) ${i.t ? ' @ ' + new Date(i.t).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}`;
            list.innerHTML += `<div class="history-item ${isH ? 'item-h2o' : ''}"><span>${left}</span><div><button class="del-btn" onclick="deleteItem(${i.id})">Ã—</button></div></div>`;
        });

        // refresh diary chart (default to selected range)
        renderDiaryChart(selectedDiaryRange);
    }

    function updateWellList() {
@@ -261,6 +295,7 @@
        bodyData.slice().reverse().forEach(i => list.innerHTML += `<div class="history-item" style="border-left-color:var(--blue)"><span>${i.date}: ${i.w}kg ${i.bf ? '('+i.bf+'%)' : ''}</span><button class="del-btn" onclick="deleteBody(${i.id})">Ã—</button></div>`);
    }

    // Body chart
    function renderChart() {
        const ctx = document.getElementById('chartBody').getContext('2d');
        if (chart) chart.destroy();
@@ -303,15 +338,138 @@
        doc.text(`Target Calories: ${config.cals}`, 20, 48);
        doc.text(`Goal Weight: ${config.weight} kg`, 20, 56);
        doc.text(`Coach Note: ${document.getElementById('coach-note').value || ''}`, 20, 72);

        // Add 7-day totals
        const summary = getDailyTotals(7);
        doc.text("Last 7 days (date: total kcal):", 20, 90);
        let y = 98;
        for (let i = 0; i < summary.labels.length; i++) {
            doc.text(`${summary.labels[i]}: ${summary.totals[i]} kcal`, 20, y);
            y += 8;
            if (y > 270) { doc.addPage(); y = 20; } // ensure we don't overflow page
        }

        doc.save('ssi-performance.pdf');
    }

    function clearAll() {
        if (confirm("Wipe all data?")) { localStorage.clear(); location.reload(); }
    }

    // Save goals when leaving goals tab
    document.getElementById('tab-goals').addEventListener('click', saveGoals);
    // CSV export
    function exportDiaryCSV() {
        if (!diary || diary.length === 0) return alert('No diary data to export');
        // Build CSV header
        const headers = ['id','type','name','calories','ml','timestamp','date'];
        const rows = diary.map(item => {
            return [
                item.id || '',
                item.type || '',
                item.n ? `"${(item.n+'').replace(/"/g,'""')}"` : '',
                item.c != null ? item.c : '',
                item.ml != null ? item.ml : '',
                item.t || '',
                item.d || ''
            ].join(',');
        });
        const csv = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const now = new Date().toISOString().split('T')[0];
        a.href = url;
        a.download = `ssi-diary-${now}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Aggregation: daily totals for last N days (days=1 returns today)
    function getDailyTotals(days = 7) {
        const totals = [];
        const labels = [];
        const now = new Date();
        for (let i = days - 1; i >= 0; i--) {
            const d = new Date(now);
            d.setDate(now.getDate() - i);
            const dayStr = d.toISOString().split('T')[0];
            const sum = diary
                .filter(it => it.type === 'food' && it.d === dayStr)
                .reduce((s, it) => s + (it.c || 0), 0);
            labels.push(dayStr);
            totals.push(sum);
        }
        return { labels, totals };
    }

    // Diary chart (actual vs target)
    function renderDiaryChart(days = 7) {
        selectedDiaryRange = days;
        const ctx = document.getElementById('chartDiary').getContext('2d');
        const { labels, totals } = getDailyTotals(days);
        const target = (config && config.cals) ? config.cals : 2500;
        const targetArray = labels.map(() => target);

        if (diaryChart) diaryChart.destroy();
        diaryChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'Actual (kcal)', data: totals, borderColor: '#ff69b4', backgroundColor: 'rgba(255,105,180,0.12)', fill: true },
                    { label: `Target (${target} kcal)`, data: targetArray, borderColor: '#ffd700', borderDash: [6,4], pointRadius: 0, fill: false }
                ]
            },
            options: {
                scales: { y: { beginAtZero: true } },
                interaction: { mode: 'index', intersect: false }
            }
        });
    }

    // askGemini now calls Netlify Function at /.netlify/functions/gemini
    async function askGemini() {
        const input = document.getElementById('ai-input').value;
        const resp = document.getElementById('ai-response');
        if (!input) return;
        resp.innerText = "Consulting SSI AI...";

        try {
            const r = await fetch('/.netlify/functions/gemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: input, strategy: config.strategy })
            });

            let d;
            const contentType = r.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                d = await r.json();
            } else {
                const text = await r.text();
                throw new Error(`Server returned non-JSON response (${r.status}): ${text.substring(0, 100)}...`);
            }

            if (!r.ok) {
                const errMsg = d.error || d.message || `Error ${r.status}`;
                resp.innerText = `System Error: ${errMsg}`;
                console.error("API Error", d);
                return;
            }

            if (d && d.candidates && d.candidates[0] && d.candidates[0].content && d.candidates[0].content.parts) {
                resp.innerText = d.candidates[0].content.parts[0].text || JSON.stringify(d);
            } else if (d && d.output && d.output[0] && d.output[0].content) {
                resp.innerText = JSON.stringify(d.output[0].content);
            } else {
                resp.innerText = JSON.stringify(d);
            }
        } catch (e) {
            console.error(e);
            resp.innerText = `Error: ${e.message}`;
        }
    }
</script>
</body>
</html>

